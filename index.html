<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh·∫≠n Coin - Bot Discord</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            width: 100%;
        }
        .timer {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            color: #ffeb3b;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
            width: 200px;
        }
        .btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .instructions {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
        }
        .error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }
        .loading {
            background: rgba(255, 193, 7, 0.3);
            border: 1px solid #ffc107;
        }
        .info-box {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ NH·∫¨N COIN T·ª™ BOT DISCORD</h1>
        
        <div id="userInfo" class="info-box" style="display: none;">
            <p><strong>Th√¥ng tin phi√™n l√†m vi·ªác:</strong></p>
            <p>D·ªãch v·ª•: <span id="serviceName"></span></p>
            <p>Ph·∫ßn th∆∞·ªüng: <span id="rewardAmount"></span> Coin</p>
            <p>User ID: <span id="userId"></span></p>
        </div>
        
        <div class="instructions">
            <p><strong>H∆∞·ªõng d·∫´n nh·∫≠n coin:</strong></p>
            <ol>
                <li>Ch·ªù ƒë·∫øm ng∆∞·ª£c 5 gi√¢y</li>
                <li>Nh·∫•n n√∫t "NH·∫¨N COIN" khi ƒë·∫øm ng∆∞·ª£c k·∫øt th√∫c</li>
                <li>Coin s·∫Ω ƒë∆∞·ª£c c·ªông t·ª± ƒë·ªông v√†o t√†i kho·∫£n Discord c·ªßa b·∫°n</li>
                <li>Ki·ªÉm tra tin nh·∫Øn ri√™ng t·ª´ bot ƒë·ªÉ x√°c nh·∫≠n</li>
            </ol>
        </div>
        
        <div class="timer" id="timer">5</div>
        
        <button class="btn" id="claimBtn" disabled>
            ƒêANG ƒê·∫æM NG∆Ø·ª¢C...
        </button>
        
        <div id="message"></div>

        <div class="info-box">
            <p><strong>L∆∞u √Ω:</strong> N·∫øu g·∫∑p l·ªói k·∫øt n·ªëi, h√£y ƒë·∫£m b·∫£o bot ƒëang ho·∫°t ƒë·ªông.</p>
        </div>
    </div>

    <script>
        // L·∫•y th√¥ng tin t·ª´ URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');
        const sessionId = urlParams.get('session_id');
        const serviceType = urlParams.get('service');

        let countdown = 5;
        const timerElement = document.getElementById('timer');
        const claimBtn = document.getElementById('claimBtn');
        const messageElement = document.getElementById('message');

        // Hi·ªÉn th·ªã th√¥ng tin user n·∫øu c√≥ ƒë·ªß tham s·ªë
        if (userId && sessionId && serviceType) {
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('serviceName').textContent = getServiceName(serviceType);
            document.getElementById('rewardAmount').textContent = getRewardAmount(serviceType);
            document.getElementById('userId').textContent = userId;
            
            // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
            startCountdown();
        } else {
            // N·∫øu thi·∫øu tham s·ªë, hi·ªÉn th·ªã th√¥ng b√°o l·ªói ngay l·∫≠p t·ª©c
            showMessage('‚ùå <strong>Thi·∫øu th√¥ng tin c·∫ßn thi·∫øt.</strong><br>Vui l√≤ng s·ª≠ d·ª•ng link t·ª´ bot Discord b·∫±ng l·ªánh <code>/getcoin</code>.', 'error');
            document.getElementById('timer').style.display = 'none';
            document.getElementById('claimBtn').style.display = 'none';
        }

        function startCountdown() {
            const countdownInterval = setInterval(() => {
                countdown--;
                timerElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    claimBtn.disabled = false;
                    claimBtn.textContent = 'üéÅ NH·∫¨N COIN NGAY';
                    timerElement.style.display = 'none';
                }
            }, 1000);
        }

        claimBtn.addEventListener('click', async function() {
            if (!userId || !sessionId || !serviceType) {
                showMessage('‚ùå <strong>Thi·∫øu th√¥ng tin c·∫ßn thi·∫øt.</strong><br>Vui l√≤ng s·ª≠ d·ª•ng link t·ª´ bot Discord.', 'error');
                return;
            }

            claimBtn.disabled = true;
            claimBtn.textContent = 'ƒêANG X·ª¨ L√ù...';
            showMessage('üîÑ ƒêang x·ª≠ l√Ω y√™u c·∫ßu nh·∫≠n coin...', 'loading');

            try {
                // S·ª≠ d·ª•ng endpoint c·ªßa bot server
                // Thay YOUR_SERVER_IP b·∫±ng IP th·ª±c c·ªßa server hosting bot
                const botServerUrl = 'http://localhost:3000';
                
                const response = await fetchWithTimeout(`${botServerUrl}/api/claim_coin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        session_id: sessionId,
                        service_type: serviceType,
                        api_key: 'tech_demon_x_omega_2024_secret_key'
                    })
                }, 10000); // 10 gi√¢y timeout

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    showMessage(
                        `‚úÖ <strong>Nh·∫≠n coin th√†nh c√¥ng!</strong><br>
                        B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c <strong>${result.reward} Coin</strong><br>
                        S·ªë d∆∞ m·ªõi: <strong>${result.new_balance} Coin</strong><br>
                        ƒê√£ s·ª≠ d·ª•ng: ${result.used_count}/${result.daily_limit} l∆∞·ª£t h√¥m nay`,
                        'success'
                    );
                    claimBtn.textContent = 'ƒê√É NH·∫¨N COIN';
                    claimBtn.style.background = '#2196F3';
                    
                    // T·ª± ƒë·ªông ƒë√≥ng tab sau 3 gi√¢y
                    setTimeout(() => {
                        if (window.history.length > 1) {
                            window.close();
                        }
                    }, 3000);
                } else {
                    showMessage(`‚ùå <strong>L·ªói:</strong> ${result.error}`, 'error');
                    claimBtn.textContent = 'TH·ª¨ L·∫†I';
                    claimBtn.disabled = false;
                }
            } catch (error) {
                console.error('Claim coin error:', error);
                showMessage(
                    `‚ùå <strong>L·ªói k·∫øt n·ªëi:</strong> Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn bot.<br>
                    Vui l√≤ng th√¥ng b√°o cho admin v√† th·ª≠ l·∫°i sau.`,
                    'error'
                );
                claimBtn.textContent = 'TH·ª¨ L·∫†I';
                claimBtn.disabled = false;
            }
        });

        // H√†m fetch v·ªõi timeout
        async function fetchWithTimeout(url, options, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        function showMessage(message, type) {
            messageElement.innerHTML = message;
            messageElement.className = `status ${type}`;
        }

        function getServiceName(serviceType) {
            const services = {
                'yeumoney': 'Yeumoney',
                'link4m': 'Link4M', 
                'linktot_rv': 'LinkTot RV Map',
                'linktot_timmap': 'LinkTot T√¨m Map'
            };
            return services[serviceType] || serviceType;
        }

        function getRewardAmount(serviceType) {
            const rewards = {
                'yeumoney': 300,
                'link4m': 200,
                'linktot_rv': 400,
                'linktot_timmap': 200
            };
            return rewards[serviceType] || 0;
        }
    </script>
</body>
</html>
